# Vercel Deployment Checklist for Klap Integration

## Pre-Deployment Verification

### 1. Code Changes Applied ✅
- [x] Fixed `setImmediate` issue (replaced with `Promise.resolve().then()`)
- [x] Increased function timeout to 300 seconds (5 minutes)
- [x] Set max clip duration to 30 seconds
- [x] Added max_clip_count limit (10 clips)

### 2. Environment Variables Required

Add these to your Vercel project settings:

```bash
# Required for Klap Integration
KLAP_API_KEY=klap_xxxxxxxxxxxxx              # Get from https://klap.app
NEXT_PUBLIC_APP_URL=https://inflio.ai         # Your production URL

# DO NOT SET this variable (leave it unset to enable clip downloads)
# SKIP_KLAP_VIDEO_REUPLOAD=true              # Don't set this!

# Other Required Variables (if not already set)
OPENAI_API_KEY=sk-...
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_...
CLERK_SECRET_KEY=sk_live_...
```

### 3. Vercel Configuration ✅

The following are already configured in your codebase:

- `maxDuration = 300` on `/api/process-klap` route
- `dynamic = 'force-dynamic'` for proper API behavior
- Proper error handling for timeouts

### 4. Production Behavior

#### What Happens During Clip Generation:
1. User uploads video with "Generate Clips" enabled
2. API starts Klap processing (returns immediately)
3. Background processing continues for 10-20 minutes
4. Clips are:
   - Generated by Klap (30-second duration each)
   - Exported from Klap
   - Downloaded to your server
   - Uploaded to Supabase storage
   - Stored with permanent URLs

#### Expected Timeline:
- Initial response: < 5 seconds
- AI analysis: 2-3 minutes
- Clip generation: 10-20 minutes (happens in background)
- User can view progress on project page

### 5. Common Issues & Solutions

| Issue | Solution |
|-------|----------|
| "Service temporarily unavailable" | Add `KLAP_API_KEY` to Vercel env vars |
| Clips not generating | Check `KLAP_API_KEY` is valid |
| Using Klap URLs instead of Supabase | Don't set `SKIP_KLAP_VIDEO_REUPLOAD` |
| Function timeout | Already fixed with 300s timeout |

### 6. Testing After Deployment

1. Visit: `https://inflio.ai/api/test-klap-simple`
   - Should show "READY" status
   - Verify all environment variables

2. Test with a short video (< 5 minutes)
   - Upload with "Generate Clips" enabled
   - Check project page for progress
   - Verify clips appear after processing

### 7. Monitoring

- Check Vercel Functions logs for `[Klap]` messages
- Monitor for 504 timeouts (normal for long videos)
- Background processing continues even after timeouts

## Deployment Steps

1. **Push Code to GitHub**
   ```bash
   git add .
   git commit -m "Fix Klap integration for production"
   git push origin master
   ```

2. **Set Environment Variables in Vercel**
   - Go to Vercel Dashboard → Your Project → Settings → Environment Variables
   - Add all required variables listed above
   - Ensure they're set for Production environment

3. **Deploy**
   - Vercel will automatically deploy on push
   - Or manually trigger deployment from dashboard

4. **Verify**
   - Check `/api/test-klap-simple` endpoint
   - Upload a test video
   - Monitor logs

## Post-Deployment

- Clips will be stored permanently in your Supabase storage
- No dependency on Klap's 30-day retention
- Full control over your content

## Support

If issues persist:
1. Check Vercel function logs
2. Verify API key at https://klap.app
3. Ensure Supabase storage bucket has sufficient space
4. Check rate limits on Klap account 